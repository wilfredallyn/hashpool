# Payment Request Implementation Development Plan

## Overview

This plan implements a complete ecash token forwarding and claiming system for hashpool. The system allows miners to automatically forward accumulated ehash tokens via Nostr to a reusable payment request, then claim those tokens later using the CDK CLI.

**Core Flow:**
1. Miner accumulates ehash tokens in translator wallet
2. When balance exceeds threshold, translator forwards tokens to a Nostr payment request  
3. Tokens are sent as gift wrap messages to the payment request's pubkey
4. Miner can later claim tokens using `just payment receive`

**Key Components:**
- CDK CLI with fixed crypto provider and proper Nostr filtering
- Translator with clean token forwarding logic using persistent config
- Justfile commands for easy payment request management

## Environment Variables vs Config Files

**Why avoid env vars for this implementation:**

1. **Persistence** - Config files survive restarts, env vars don't unless exported to shell
2. **Visibility** - Config is explicit and version-controlled, env vars are hidden
3. **Simplicity** - One source of truth in config file vs multiple override mechanisms  
4. **Debugging** - Easy to see current config, harder to debug missing env vars
5. **CDK compatibility** - CDK CLI expects persistent keys, not ephemeral env vars

**When env vars make sense:**
- Secrets that shouldn't be in version control (but we're using test keys)
- Runtime overrides for different environments  
- CI/CD deployment variations

For this dev environment with test keys, config files provide better developer experience and maintainability.

## Problem Analysis

The current implementation has multiple fundamental issues:

1. **CDK CLI crypto provider panics** - Missing rustls crypto provider initialization
2. **Inefficient Nostr filtering** - Downloads all gift wrap messages instead of filtering by recipient
3. **Missing mint URLs in payment requests** - Hash currency payment requests don't include mint URL
4. **Persistent connection issues** - Nostr connections not properly managed
5. **Complex configuration flow** - Multiple scattered config changes and environment variables
6. **Incomplete receive workflow** - No clear way to claim forwarded tokens

## Lessons Learned

### Critical Issues
- **Always initialize crypto providers first** - rustls panics without `install_default()`
- **Filter Nostr events properly** - Use p-tag filtering for gift wraps to avoid downloading trash
- **Include mint URLs in payment requests** - Hash currency needs explicit mint URL since wallets may be empty
- **Use deterministic keys from config** - Don't generate random keys, use persistent ones from config
- **Close Nostr connections properly** - Use on-demand connections, not persistent ones
- **Build and copy CLI binary** - `just up` doesn't auto-rebuild CLI, must copy to bin/

### Working Patterns
- **Reusable payment requests** - Better for continuous forwarding than single-use
- **Config-driven approach** - Store persistent keys in config files, not environment variables  
- **Proper error handling** - Validate payment requests before using
- **Clear separation** - Keep CDK changes minimal, put logic in hashpool

## Complete Implementation Plan

### Phase 1: CDK CLI Fixes (Required Foundation)

1. **Fix crypto provider initialization**
   - Add `rustls = { version = "0.23", features = ["aws-lc-rs"] }` to Cargo.toml
   - Initialize in main(): `rustls::crypto::aws_lc_rs::default_provider().install_default()?`

2. **Fix create-request command**
   - Add `--nostr-privkey` option to accept hex private keys
   - Add `--reusable` flag for multi-use payment requests
   - Fix mint URL inclusion for hash currency (add localhost:3338 fallback)
   - Skip listening for reusable requests (they can be paid multiple times)

3. **Fix receive command**
   - Implement proper gift wrap filtering with p-tag: 
     ```rust
     Filter::new()
         .kind(Kind::GiftWrap)
         .custom_tag(SingleLetterTag::lowercase(Alphabet::P), pubkey.to_hex())
     ```
   - Add relays to client BEFORE connecting
   - Remove unused imports (nip04)

### Phase 2: Hashpool Integration (Clean Implementation)

1. **Update translator configuration**
   - Add nut18_forwarding section to tproxy.config.toml:
     ```toml
     [nut18_forwarding]
     enabled = true
     nostr_privkey = "0000000000000000000000000000000000000021000000"
     payment_request = ""  # Generated by just command
     sweep_threshold = 50
     sweep_interval_secs = 30
     ```

2. **Implement clean forwarding logic**
   - Remove the messy environment variable override code
   - Implement simple periodic task that checks balance and forwards if > threshold
   - Use on-demand Nostr connections (connect, send, disconnect)
   - Log recipient pubkey for debugging

3. **Add justfile commands**
   - `just payment request` - Generate reusable payment request with persistent key
   - `just payment receive` - Receive tokens sent to payment request
   - `just clean logs` - Delete log files

### Phase 3: Testing and Validation

1. **Build and deployment**
   - Build CDK CLI: `cargo build -p cdk-cli`  
   - Copy binary: `cp target/debug/cdk-cli bin/cdk-cli`
   - Restart hashpool services

2. **End-to-end test**
   - Generate payment request: `just payment request`
   - Mine shares to trigger forwarding
   - Receive tokens: `just payment receive`
   - Verify filtering works (should see 0 events if no tokens, not hundreds)

## Key Files to Modify

### CDK Repository Changes (Minimal)
- `crates/cdk-cli/Cargo.toml` - Add rustls dependency
- `crates/cdk-cli/src/main.rs` - Initialize crypto provider
- `crates/cdk-cli/src/sub_commands/create_request.rs` - Add nostr-privkey and reusable options
- `crates/cdk-cli/src/sub_commands/receive.rs` - Fix gift wrap filtering

### Hashpool Repository Changes  
- `config/tproxy.config.toml` - Add nut18_forwarding section
- `justfile` - Add payment and clean logs commands
- `roles/translator/src/lib/mod.rs` - Clean forwarding implementation

## Success Criteria

1. CDK CLI builds without errors
2. `just payment request` generates valid payment request with mint URL
3. `just payment receive` only downloads relevant events (0 if none, not hundreds)
4. Token forwarding works after mining shares
5. Received tokens appear in wallet balance
6. No crypto provider panics
7. Nostr connections are properly managed (on-demand)

## Critical Implementation Notes

- **Do not** use environment variables for config override - use config file only
- **Do not** maintain persistent Nostr connections - connect on-demand
- **Do not** generate random keys - use deterministic keys from config  
- **Always** copy CLI binary to bin/ after building
- **Always** include mint URLs in hash currency payment requests
- **Always** filter Nostr events by recipient to avoid downloading trash

## Implementation Details (Updated)

### Just Recipe
```bash
# payment request operations: create or receive
payment TYPE="" MEMO="Hashpool Development Forwarding":
    #!/bin/bash
    if [ "{{TYPE}}" = "request" ]; then
        echo "ðŸ”„ Generating new reusable payment request with persistent key..."
        PRIVKEY=$(grep 'nostr_privkey' config/tproxy.config.toml | cut -d'"' -f2)
        if [ -z "$PRIVKEY" ]; then
            echo "âŒ Error: nostr_privkey not found in config"
            exit 1
        fi
        NEW_REQUEST=$(./bin/cdk-cli create-request --amount 100 --reusable --nostr-privkey "$PRIVKEY" hash "{{MEMO}}")
        echo "ðŸ“ Updating config file..."
        sed -i "s#payment_request = \".*\"#payment_request = \"$NEW_REQUEST\"#" config/tproxy.config.toml
        echo "âœ… Updated payment request in config/tproxy.config.toml"
        echo "ðŸ” New payment request: $NEW_REQUEST"
        echo ""
        ./bin/cdk-cli decode-request "$NEW_REQUEST"
    elif [ "{{TYPE}}" = "receive" ]; then
        echo "ðŸŽ¯ Receiving tokens sent to payment request..."
        PRIVKEY=$(grep 'nostr_privkey' config/tproxy.config.toml | cut -d'"' -f2)
        if [ -z "$PRIVKEY" ]; then
            echo "âŒ Error: nostr_privkey not found in config"
            exit 1
        fi
        echo "ðŸ”‘ Using private key from config: $PRIVKEY"
        SINCE=$(($(date +%s) - 3600))  # Look back 1 hour
        ./bin/cdk-cli receive --nostr-key "$PRIVKEY" -r "wss://relay.nos.social" -r "wss://relay.damus.io" --since "$SINCE"
    else
        echo "Error: TYPE must be 'request' or 'receive'"
        exit 1
    fi
```

### Configuration Updates
```toml
[nut18_forwarding]
enabled = true
nostr_privkey = "0000000000000000000000000000000000000021000000"  # Persistent test key
payment_request = ""  # Generated by just payment request
sweep_threshold = 50
sweep_interval_secs = 30
```

### Startup Validation (in translator)
```rust
fn validate_payment_request(nut18_config: &proxy_config::Nut18Config) -> Result<(), String> {
    use std::str::FromStr;
    
    let request = PaymentRequest::from_str(&nut18_config.payment_request)
        .map_err(|e| format!("Invalid payment request: {}", e))?;
    
    // Check single_use
    if request.single_use == Some(true) {
        return Err("Payment request must be reusable (single_use = false)".to_string());
    }
    
    // Check mint URL for hash currency
    if let Some(unit) = &request.unit {
        if unit.to_string() == "hash" {
            if let Some(mints) = &request.mints {
                let has_local_mint = mints.iter().any(|m| m.to_string().contains("localhost:3338"));
                if !has_local_mint {
                    warn!("Payment request doesn't include local mint (http://localhost:3338)");
                }
            }
        }
    }
    
    Ok(())
}
```

## Previous Implementation Issues

### What Went Wrong
1. **Crypto provider panics** - CDK CLI crashed without rustls initialization
2. **Inefficient filtering** - Downloaded hundreds of irrelevant gift wrap messages
3. **Missing mint URLs** - Hash currency payment requests were incomplete
4. **Configuration complexity** - Multiple override mechanisms caused confusion
5. **Connection management** - Persistent Nostr connections weren't properly closed
6. **Build process** - CLI updates weren't copied to bin/ directory

### Fixes Applied
1. **Crypto provider** - Added rustls dependency and initialization in main()
2. **Proper filtering** - Use p-tag filtering for gift wraps by recipient pubkey
3. **Mint URL inclusion** - Add localhost:3338 fallback for hash currency
4. **Single config source** - Use config file only, remove env var overrides
5. **On-demand connections** - Connect, send, disconnect pattern for Nostr
6. **Build automation** - Must copy CLI binary after building


## Benefits of This Approach

### For Developers
- âœ… **Config-driven**: All settings in one place, version controlled
- âœ… **Persistent keys**: Same keys across restarts, predictable
- âœ… **Efficient filtering**: Only downloads relevant Nostr events
- âœ… **Easy commands**: `just payment request/receive` for management

### For Debugging
- âœ… **Clear logs**: Shows pubkey being sent to, connection status
- âœ… **Validation**: Startup checks catch configuration issues
- âœ… **Minimal changes**: CDK changes are focused and minimal
- âœ… **No hanging**: Reusable requests don't wait indefinitely